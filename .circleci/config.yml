version: 2.1

aliases:
  - &node_env
    - image: circleci/node:8-stretch
  - &node_mongo_env
    - image: circleci/node:8-stretch
    - image: circleci/mongo:3.6
  - &run_npm_install
    name: Installing Dependencies
    command: yarn
  - &set_version
    run: |
      export VERSION=`node -e "const fs = require('fs'); console.log(JSON.parse(fs.readFileSync('./package.json')).version);"`
      echo $VERSION-$CIRCLE_BUILD_NUM > version
  - &set_servicename
    run: basename $PWD > servicename
  - &test_steps
      - restore_cache:
          keys:
            - yarn-deps-{{ .Branch }}-{{ .Revision }}
      - run: yarn test
  - &build_steps
      - setup_remote_docker
      - restore_cache:
          keys:
            - yarn-deps-{{ .Branch }}-{{ .Revision }}
      - *set_version
      - *set_servicename
      - save_cache: 
          key: yarn-deps-{{ .Branch }}-{{ .Revision }}-build
          paths:
            - ~/oih
      - run: |
          export SERVICENAME=`cat servicename`
          export VERSION=`cat version`
          echo $SERVICENAME $VERSION
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
          yarn run build:docker
          docker tag openintegrationhub/${SERVICENAME}:${VERSION} openintegrationhub/${SERVICENAME}:latest
          docker push openintegrationhub/${SERVICENAME}:${VERSION}
          docker push openintegrationhub/${SERVICENAME}:latest
  - &deploy_steps
      - restore_cache:
          keys:
            - yarn-deps-{{ .Branch }}-{{ .Revision }}-build
      - run: |
          export SERVICENAME=`cat servicename`
          export VERSION=`cat version`
          echo $SERVICENAME $VERSION
          # ./scripts/install-gcloud.sh
          echo 'Command  kubectl set image deployment/${servicename}  ${servicename}=openintegrationhub/${servicename}:${VERSION}'
jobs:
  deps:
    docker: *node_env
    working_directory: ~/oih
    steps: 
      - checkout: 
          path: ~/oih
      - run: *run_npm_install
      - save_cache: 
          key: yarn-deps-{{ .Branch }}-{{ .Revision }}
          paths:
            - ~/oih
  iam-test:
    docker: *node_env
    working_directory: ~/oih/services/iam
    steps: *test_steps
  iam-build:
    docker: *node_env
    working_directory: ~/oih/services/iam
    steps: *build_steps
  iam-deploy:
    docker: *node_env
    working_directory: ~/oih/services/iam
    steps: *deploy_steps
  secret-service-test:
    docker: *node_env
    working_directory: ~/oih/services/secret-service
    steps: *test_steps
  secret-service-build:
    docker: *node_env
    working_directory: ~/oih/services/secret-service
    steps: *build_steps
  secret-service-deploy:
    docker: *node_env
    working_directory: ~/oih/services/secret-service
    steps: *deploy_steps
workflows:
  pipeline_iam:
    jobs:
      - deps
      - iam-test:
          requires:
            - deps
      - iam-build:
          requires:
            - iam-test
      - iam-deploy:
          requires:
            - iam-build
  pipeline_secret-service:
    jobs:
      - deps
      - secret-service-test:
          requires:
            - deps
      - secret-service-build:
          requires:
            - secret-service-test
      - secret-service-deploy:
          requires:
            - secret-service-build